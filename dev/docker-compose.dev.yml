# Docker Compose dev orchestration for the full monorepo.
#
# Networking: All services share the default bridge network created by Docker
# Compose. Services can reach each other by their Compose service name (e.g.,
# "postgres", "nextjs", "cloud-agent") via Docker's built-in DNS. This works
# on both macOS (Docker Desktop) and Linux — no network_mode: host needed.
#
# Because wrangler.jsonc files hardcode "localhost" for inter-service URLs
# (Hyperdrive connection strings, KILOCODE_BACKEND_BASE_URL, etc.), wrangler
# workers use dev/docker-wrangler-entrypoint.sh which creates a patched copy
# of wrangler.jsonc at startup, replacing "localhost" with Docker service names.
#
# The Next.js service overrides env vars directly via the `environment:` key
# so that POSTGRES_URL, CLOUD_AGENT_API_URL, etc. point to Docker service names.
#
# Usage:
#   docker compose -f dev/docker-compose.dev.yml up                          # everything
#   docker compose -f dev/docker-compose.dev.yml up postgres nextjs          # core only
#   docker compose -f dev/docker-compose.dev.yml up postgres cloud-agent     # postgres + one worker
#   docker compose -f dev/docker-compose.dev.yml up --profile core           # postgres + nextjs
#   docker compose -f dev/docker-compose.dev.yml up --profile core --profile agents  # core + agents

x-worker-base: &worker-base
  build:
    context: ..
    dockerfile: dev/Dockerfile.dev
  volumes:
    - ..:/app
  extra_hosts:
    - "host.docker.internal:host-gateway"
  restart: unless-stopped

services:
  # ── PostgreSQL (always starts — no profile) ─────────────────────────
  postgres:
    image: pgvector/pgvector:0.8.0-pg18
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "127.0.0.1:5432:5432"
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── 1. Next.js backend (port 3000) ──────────────────────────────────
  nextjs:
    <<: *worker-base
    profiles: ["core", "all"]
    ports:
      - "127.0.0.1:3000:3000"
    env_file:
      - ../.env
    # Override localhost URLs so Next.js can reach other services on the
    # Docker bridge network by service name.
    environment:
      - POSTGRES_URL=postgres://postgres:postgres@postgres:5432/postgres
      - CLOUD_AGENT_API_URL=http://cloud-agent:8788
      - WEBHOOK_AGENT_URL=http://cloudflare-webhook-agent-ingest:8793
    depends_on:
      postgres:
        condition: service_healthy
    command: ["pnpm", "dev"]

  # ── 2. cloud-agent (port 8788) ─────────────────────────────────────
  # Uses docker-wrangler-entrypoint.sh to patch wrangler.jsonc localhost
  # references (KILOCODE_BACKEND_BASE_URL, Hyperdrive, etc.) to Docker
  # service names before starting wrangler dev.
  cloud-agent:
    <<: *worker-base
    profiles: ["agents", "workers", "all"]
    ports:
      - "127.0.0.1:8788:8788"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloud-agent --env dev --port 8788 --ip 0.0.0.0

  # ── 3. cloud-agent-next (port 8794) ────────────────────────────────
  cloud-agent-next:
    <<: *worker-base
    profiles: ["agents", "all"]
    ports:
      - "8794:8794"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloud-agent-next --env dev --port 8794 --ip 0.0.0.0

  # ── 4. cloudflare-ai-attribution (port 8787) ───────────────────────
  cloudflare-ai-attribution:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8787:8787"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-ai-attribution --env dev --port 8787 --ip 0.0.0.0

  # ── 5. cloudflare-app-builder (port 8790) ──────────────────────────
  cloudflare-app-builder:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8790:8790"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-app-builder --port 8790 --ip 0.0.0.0

  # ── 6. cloudflare-auto-fix-infra (port 8796) ──────────────────────
  cloudflare-auto-fix-infra:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8796:8796"
    depends_on:
      postgres:
        condition: service_healthy
      cloud-agent:
        condition: service_started
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-auto-fix-infra --port 8796 --ip 0.0.0.0

  # ── 7. cloudflare-auto-triage-infra (port 8791) ───────────────────
  cloudflare-auto-triage-infra:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8791:8791"
    depends_on:
      postgres:
        condition: service_healthy
      cloud-agent:
        condition: service_started
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-auto-triage-infra --port 8791 --ip 0.0.0.0

  # ── 8. cloudflare-code-review-infra (port 8789) ───────────────────
  cloudflare-code-review-infra:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8789:8789"
    depends_on:
      postgres:
        condition: service_healthy
      cloud-agent:
        condition: service_started
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-code-review-infra --port 8789 --ip 0.0.0.0

  # ── 9. cloudflare-db-proxy (port 8797) ─────────────────────────────
  cloudflare-db-proxy:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8797:8797"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-db-proxy --port 8797 --ip 0.0.0.0

  # ── 10. cloudflare-deploy-infra/builder (port 8798) ────────────────
  cloudflare-deploy-builder:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8798:8798"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-deploy-infra/builder --port 8798 --ip 0.0.0.0

  # ── 11. cloudflare-deploy-infra/dispatcher (port 8799) ─────────────
  cloudflare-deploy-dispatcher:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8799:8799"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-deploy-infra/dispatcher --port 8799 --ip 0.0.0.0

  # ── 12. cloudflare-session-ingest (port 8800) ─────────────────────
  cloudflare-session-ingest:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8800:8800"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-session-ingest --port 8800 --ip 0.0.0.0

  # ── 13. cloudflare-o11y (port 8801) ────────────────────────────────
  cloudflare-o11y:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8801:8801"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-o11y --port 8801 --ip 0.0.0.0

  # ── 14. cloudflare-webhook-agent-ingest (port 8793) ────────────────
  cloudflare-webhook-agent-ingest:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8793:8793"
    depends_on:
      postgres:
        condition: service_healthy
      cloud-agent:
        condition: service_started
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-webhook-agent-ingest --env dev --port 8793 --ip 0.0.0.0

  # ── 15. cloudflare-git-token-service (port 8802) ──────────────────
  cloudflare-git-token-service:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8802:8802"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh cloudflare-git-token-service --port 8802 --ip 0.0.0.0

  # ── 16. kiloclaw (port 8795) ───────────────────────────────────────
  kiloclaw:
    <<: *worker-base
    profiles: ["workers", "all"]
    ports:
      - "8795:8795"
    depends_on:
      postgres:
        condition: service_healthy
    command: /app/dev/docker-wrangler-entrypoint.sh kiloclaw --port 8795 --ip 0.0.0.0

volumes:
  postgres_data:
