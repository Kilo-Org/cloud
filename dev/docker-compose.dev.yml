# Docker Compose dev orchestration for the full monorepo.
#
# Usage:
#   docker compose -f dev/docker-compose.dev.yml up                          # everything
#   docker compose -f dev/docker-compose.dev.yml up postgres nextjs          # core only
#   docker compose -f dev/docker-compose.dev.yml up postgres cloud-agent     # postgres + one worker
#   docker compose -f dev/docker-compose.dev.yml up --profile core           # postgres + nextjs
#   docker compose -f dev/docker-compose.dev.yml up --profile core --profile agents  # core + agents

x-worker-base: &worker-base
  build:
    context: ..
    dockerfile: dev/Dockerfile.dev
  volumes:
    - ..:/app
  network_mode: host
  restart: unless-stopped

services:
  # ── PostgreSQL (always starts — no profile) ─────────────────────────
  postgres:
    image: pgvector/pgvector:pg18
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    network_mode: host
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── 1. Next.js backend (port 3000) ──────────────────────────────────
  nextjs:
    <<: *worker-base
    profiles: ["core", "all"]
    env_file:
      - ../.env
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "pnpm dev"

  # ── 2. cloud-agent (port 8788) ─────────────────────────────────────
  cloud-agent:
    <<: *worker-base
    profiles: ["agents", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloud-agent && pnpm dev --port 8788"

  # ── 3. cloud-agent-next (port 8794) ────────────────────────────────
  cloud-agent-next:
    <<: *worker-base
    profiles: ["agents", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloud-agent-next && pnpm dev --port 8794"

  # ── 4. cloudflare-ai-attribution (port 8787) ───────────────────────
  cloudflare-ai-attribution:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloudflare-ai-attribution && pnpm dev --port 8787"

  # ── 5. cloudflare-app-builder (port 8790) ──────────────────────────
  cloudflare-app-builder:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloudflare-app-builder && pnpm dev --port 8790"

  # ── 6. cloudflare-auto-fix-infra (port 8796) ──────────────────────
  cloudflare-auto-fix-infra:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
      cloud-agent:
        condition: service_started
    command: sh -c "cd /app/cloudflare-auto-fix-infra && pnpm dev --port 8796"

  # ── 7. cloudflare-auto-triage-infra (port 8791) ───────────────────
  cloudflare-auto-triage-infra:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
      cloud-agent:
        condition: service_started
    command: sh -c "cd /app/cloudflare-auto-triage-infra && pnpm dev --port 8791"

  # ── 8. cloudflare-code-review-infra (port 8789) ───────────────────
  cloudflare-code-review-infra:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
      cloud-agent:
        condition: service_started
    command: sh -c "cd /app/cloudflare-code-review-infra && pnpm dev --port 8789"

  # ── 9. cloudflare-db-proxy (port 8797) ─────────────────────────────
  cloudflare-db-proxy:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloudflare-db-proxy && pnpm dev --port 8797"

  # ── 10. cloudflare-deploy-infra/builder (port 8798) ────────────────
  cloudflare-deploy-builder:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloudflare-deploy-infra/builder && pnpm dev --port 8798"

  # ── 11. cloudflare-deploy-infra/dispatcher (port 8799) ─────────────
  cloudflare-deploy-dispatcher:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloudflare-deploy-infra/dispatcher && pnpm dev --port 8799"

  # ── 12. cloudflare-session-ingest (port 8800) ─────────────────────
  cloudflare-session-ingest:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloudflare-session-ingest && pnpm dev --port 8800"

  # ── 13. cloudflare-o11y (port 8801) ────────────────────────────────
  cloudflare-o11y:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloudflare-o11y && pnpm dev --port 8801"

  # ── 14. cloudflare-webhook-agent-ingest (port 8793) ────────────────
  cloudflare-webhook-agent-ingest:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
      cloud-agent:
        condition: service_started
    command: sh -c "cd /app/cloudflare-webhook-agent-ingest && pnpm dev --port 8793"

  # ── 15. cloudflare-git-token-service (port 8802) ──────────────────
  cloudflare-git-token-service:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/cloudflare-git-token-service && pnpm dev --port 8802"

  # ── 16. kiloclaw (port 8795) ───────────────────────────────────────
  kiloclaw:
    <<: *worker-base
    profiles: ["workers", "all"]
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/kiloclaw && pnpm dev --port 8795"

volumes:
  postgres_data:
