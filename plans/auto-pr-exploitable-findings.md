# Auto-PR Creation for Exploitable Security Findings — Implementation Plan

## Overview
Automatically create a PR to fix a security finding when analysis determines it is **Exploitable** (with `suggestedAction: 'open_pr'`). This leverages existing infrastructure (analysis results, auto-dismiss patterns, and cloud-agent-next) to close the loop from detection → analysis → remediation.

## Settings

New settings to be added to the security agent configuration:

| Setting | Type | Default | Description |
|---|---|---|---|
| `autoCreatePR` | boolean | `true` | Enable/disable automatic PR creation for Exploitable findings |
| `autoCreatePRSeverities` | string[] | `['critical', 'high', 'medium', 'low']` | Which severity levels trigger auto-PR |

These settings follow the same pattern as the existing auto-analyze and auto-dismiss settings.

## Architecture

### Trigger Point
- After analysis completes and the finding is marked as `isExploitable: true` with `suggestedAction: 'open_pr'`
- The auto-PR service checks the org's settings to see if `autoCreatePR` is enabled and if the finding's severity is in the allowed list

### New Components

1. **`auto-pr-service.ts`** — Core service that:
   - Listens for completed analyses where `isExploitable === true` and `suggestedAction === 'open_pr'`
   - Checks org settings (`autoCreatePR` enabled, severity filter)
   - Invokes cloud-agent-next to generate the fix and open a PR
   - Updates the security finding record with the PR URL and status

2. **Settings Migration** — Add `autoCreatePR` and `autoCreatePRSeverities` to the security agent settings schema and DB migration

3. **UI Updates** — Add toggle and severity selector to the Security Agent settings page

### Flow

```
Analysis Complete (isExploitable: true, suggestedAction: 'open_pr')
  │
  ▼
auto-pr-service checks settings
  │
  ├── autoCreatePR disabled? → STOP
  ├── severity not in allowed list? → STOP
  │
  ▼
Invoke cloud-agent-next with:
  - Repository context
  - Vulnerability details (CVE, package, version)
  - Suggested fix from analysis
  │
  ▼
cloud-agent-next creates branch, applies fix, opens PR
  │
  ▼
Update security finding with PR URL + status
```

## Existing Building Blocks

| Capability | Status | Location |
|---|---|---|
| Analysis flags `isExploitable` + `suggestedAction: 'open_pr'` | ✅ Exists | `core/types.ts` |
| Auto-dismiss pattern (template for auto-PR) | ✅ Exists | `auto-dismiss-service.ts` |
| cloud-agent-next integration | ✅ Exists / In Progress | `jdp/security-agent-next-phase-1` branch |
| Security agent settings pattern | ✅ Exists | Settings schema + UI |

## Implementation Phases

### Phase 1: Backend Foundation
- Add `autoCreatePR` and `autoCreatePRSeverities` to settings schema
- DB migration for new settings columns
- Create `auto-pr-service.ts` following the auto-dismiss-service pattern
- Wire up the trigger after analysis completion

### Phase 2: cloud-agent-next Integration
- Define the prompt/context passed to cloud-agent-next for fix generation
- Handle PR creation response (capture PR URL, branch name)
- Error handling and retry logic

### Phase 3: UI & UX
- Add settings toggles to Security Agent settings page
- Show PR link on finding detail view when a PR has been created
- Add status indicators (PR pending, PR created, PR merged)

### Phase 4: Polish & Safety
- Rate limiting (prevent PR flood on initial enable)
- Duplicate PR detection (don't create multiple PRs for the same finding)
- Audit logging for auto-created PRs
- Notification to user when auto-PR is created

## Dependencies
- `jdp/security-agent-next-phase-1` branch work (cloud-agent-next migration) should ideally land first or be coordinated
- GitHub App permissions must include write access for PR creation (likely already present)

## Risks & Mitigations

| Risk | Mitigation |
|---|---|
| Bad automated fixes | PRs require human review before merge; add confidence score |
| PR flood on enable | Rate limiting + batch processing |
| Duplicate PRs | Track PR status per finding; skip if PR already exists |
| cloud-agent-next availability | Queue + retry mechanism; mark finding as "PR pending" |
